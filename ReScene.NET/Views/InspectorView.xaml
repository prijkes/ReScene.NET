<UserControl xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:ReScene.NET.ViewModels"
             xmlns:controls="clr-namespace:ReScene.NET.Controls"
             x:Class="ReScene.NET.Views.InspectorView"
             x:Name="InspectorRoot">

  <!-- ── Inspector panels ──────────────────────────────────── -->
  <DockPanel>
    <TextBlock DockPanel.Dock="Top"
               Text="Inspect the internal structure of SRR, SRS, and RAR files. Browse blocks in the tree, view properties for each block, and examine raw hex data."
               Foreground="{DynamicResource ForegroundSecondary}" FontSize="{DynamicResource FontSizeCaption}"
               TextWrapping="Wrap" Margin="4,4,4,4" />

    <!-- File selection bar -->
    <StackPanel DockPanel.Dock="Top" Margin="6,0,6,4">
      <TextBlock Text="File" FontWeight="SemiBold" Margin="0,0,0,2" />
      <DockPanel>
        <Button DockPanel.Dock="Right" Content="Browse"
                Command="{Binding BrowseFileCommand}"
                Style="{StaticResource GhostButton}"
                Margin="4,0,0,0" MinWidth="75" />
        <TextBox Text="{Binding LoadedFilePath}"
                 IsReadOnly="True"
                 FontSize="{DynamicResource FontSizeBody}" />
      </DockPanel>
    </StackPanel>

    <!-- Warning bar for custom packer detection -->
    <Border DockPanel.Dock="Top"
            Visibility="{Binding HasWarning, Converter={StaticResource BoolToVisibility}}"
            Background="#3DE0A030" BorderBrush="#E0A030" BorderThickness="1"
            CornerRadius="3" Margin="6,0,6,4" Padding="8,5">
      <TextBlock Text="{Binding WarningMessage}"
                 Foreground="#FFD080"
                 FontSize="{DynamicResource FontSizeBody}"
                 TextWrapping="Wrap" />
    </Border>

  <Grid>
    <Grid.ColumnDefinitions>
      <ColumnDefinition Width="280" />
      <ColumnDefinition Width="Auto" />
      <ColumnDefinition Width="*" />
    </Grid.ColumnDefinitions>

      <!-- Left panel: Structure -->
      <Border Grid.Column="0"
              Style="{StaticResource PanelSection}"
              Margin="2,2,0,2">
        <DockPanel>
          <!-- Panel header -->
          <Border DockPanel.Dock="Top" Style="{StaticResource PanelHeaderBar}">
            <TextBlock Style="{StaticResource PanelHeaderText}" Text="Structure" />
          </Border>

          <!-- Filter box -->
          <TextBox DockPanel.Dock="Top"
                   Text="{Binding TreeFilterText, UpdateSourceTrigger=PropertyChanged}"
                   Margin="{DynamicResource TreeFilterMargin}" />

          <TreeView ItemsSource="{Binding TreeRoots}"
                    SelectedItemChanged="TreeView_SelectedItemChanged"
                    Margin="{DynamicResource TreeViewMargin}"
                    FontSize="{DynamicResource FontSizeBody}">
            <TreeView.ItemTemplate>
              <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                <TextBlock Text="{Binding Text}"
                           Visibility="{Binding IsVisible, Converter={StaticResource BoolToVisibility}}"
                           TextTrimming="CharacterEllipsis" />
              </HierarchicalDataTemplate>
            </TreeView.ItemTemplate>
            <TreeView.ContextMenu>
              <ContextMenu DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}">
                <MenuItem Header="Export..."
                          Command="{Binding ExportStoredFileCommand}" />
              </ContextMenu>
            </TreeView.ContextMenu>
          </TreeView>
        </DockPanel>
      </Border>

      <!-- Splitter -->
      <GridSplitter Grid.Column="1"
                    Width="{DynamicResource SplitterWidth}"
                    ResizeBehavior="PreviousAndNext" />

      <!-- Right panel: Properties + Hex -->
      <Grid Grid.Column="2"
            Margin="0,2,2,2">
        <Grid.RowDefinitions>
          <RowDefinition Height="*" />
          <RowDefinition Height="Auto" />
          <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Properties panel -->
        <Border Style="{StaticResource PanelSection}">
          <DockPanel>
            <!-- Panel header -->
            <Border DockPanel.Dock="Top" Style="{StaticResource PanelHeaderBar}">
              <TextBlock Style="{StaticResource PanelHeaderText}" Text="Properties" />
            </Border>

            <Grid>
              <!-- DataGrid -->
              <DataGrid ItemsSource="{Binding Properties}"
                        SelectedItem="{Binding SelectedProperty}"
                        IsReadOnly="True"
                        CanUserResizeColumns="True"
                        CanUserReorderColumns="False"
                        CanUserSortColumns="False"
                        GridLinesVisibility="Horizontal"
                        HeadersVisibility="Column"
                        SelectionMode="Single"
                        BorderThickness="0"
                        AutoGenerateColumns="False">
                <DataGrid.Columns>
                  <DataGridTemplateColumn Header="Property" Width="200">
                    <DataGridTemplateColumn.CellTemplate>
                      <DataTemplate>
                        <TextBlock Text="{Binding Name}" TextTrimming="CharacterEllipsis">
                          <TextBlock.Style>
                            <Style TargetType="TextBlock">
                              <Setter Property="Margin" Value="2,0,0,0" />
                              <Style.Triggers>
                                <DataTrigger Binding="{Binding IsIndented}" Value="True">
                                  <Setter Property="Margin" Value="20,0,0,0" />
                                  <Setter Property="Foreground" Value="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                                </DataTrigger>
                              </Style.Triggers>
                            </Style>
                          </TextBlock.Style>
                        </TextBlock>
                      </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                  </DataGridTemplateColumn>
                  <DataGridTemplateColumn Header="Value" Width="*">
                    <DataGridTemplateColumn.CellTemplate>
                      <DataTemplate>
                        <TextBlock Text="{Binding Value}" TextTrimming="CharacterEllipsis">
                          <TextBlock.Style>
                            <Style TargetType="TextBlock">
                              <Setter Property="Margin" Value="2,0,0,0" />
                              <Style.Triggers>
                                <DataTrigger Binding="{Binding IsWarning}" Value="True">
                                  <Setter Property="Foreground" Value="#FFD080" />
                                </DataTrigger>
                              </Style.Triggers>
                            </Style>
                          </TextBlock.Style>
                        </TextBlock>
                      </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                  </DataGridTemplateColumn>
                </DataGrid.Columns>
              </DataGrid>

              <!-- Empty state overlay -->
              <TextBlock Text="Select a tree node to view properties"
                         Visibility="{Binding HasProperties, Converter={StaticResource InverseBoolToVisibility}}"
                         HorizontalAlignment="Center"
                         VerticalAlignment="Center"
                         FontSize="{DynamicResource EmptyStateFontSize}"
                         Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                         IsHitTestVisible="False" />
            </Grid>
          </DockPanel>
        </Border>

        <!-- Splitter between properties and hex -->
        <GridSplitter Grid.Row="1"
                      Height="{DynamicResource SplitterHeight}"
                      HorizontalAlignment="Stretch"
                      ResizeBehavior="PreviousAndNext" />

        <!-- Hex view panel -->
        <Border Grid.Row="2"
                Style="{StaticResource PanelSection}">
          <DockPanel>
            <!-- Panel header -->
            <Border DockPanel.Dock="Top" Style="{StaticResource PanelHeaderBar}">
              <TextBlock Style="{StaticResource PanelHeaderText}" Text="Hex View" />
            </Border>

            <controls:HexViewControl Data="{Binding HexData}"
                                      BlockOffset="{Binding HexBlockOffset}"
                                      BlockLength="{Binding HexBlockLength}"
                                      SelectionOffset="{Binding HexSelectionOffset}"
                                      SelectionLength="{Binding HexSelectionLength}" />
          </DockPanel>
        </Border>

      </Grid>
  </Grid>
  </DockPanel>

</UserControl>
